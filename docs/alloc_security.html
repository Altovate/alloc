<html>
<head>
  <title>Alloc's Security Design and Implementation</title>
</head>

<body>

<h1>Alloc's Security Requirements and Implementation</h1>

<h2>Security Requirements</h2>
The following security operations are required by Alloc:
<ul>
  <li>Each user is authenticated using a unique username and a password.
  <li>Users must be authenticated before accessing any functionality.
  <li>Once a user has been authenticated by entering their username and password they remain authenticated until they log out or their session times out.
  <li>Users may be assigned none, one or more than one of the permissions listed below:
    <table border="1" cellspacing="0" cellpadding="2">
      <tr>
        <th>Name</th>
        <th>Definition</th>
      </tr>
      <tr>
        <td>admin</td>
        <td>Permission to perform company administration functions
      </tr>
      <tr>
        <td>manage</td>
        <td>Permission to perform management functions
      </tr>
      <tr>
        <td>employee</td>
        <td>An employee of Cybersource
      </tr>
      <tr>
        <td>tasks</td>
        <td>Permission to view and update task details
      </tr>
    </table><br>
    <i>Table 1 - Permission definitions.</i><br>
  <li>The functionality available to each user should be limitted as follows:
    <table border="1" cellspacing="0" cellpadding="2">
      <tr>
        <th>Function</th>
        <th>Permissions Required</th>
        <th>Additional Requirements</th>
      </tr>
      <tr>
        <td>View client list</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View client details</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Create a client</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Modify client details</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Delete client</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Enter a new expense</td>
        <td>employee</td>
        <td></td>
      </tr>
      <tr>
        <td>View an existing expense</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Approve an expense</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Modify an existing expense</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Delete an expense</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View an invoice's details</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Allocate an invoice item to a TF</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View a list of invoices</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Upload an invoice data file</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Create a new TF</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View a TF's details (e.g. comments)</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Modify a TF's details</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Delete a TF</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View a list of TFs</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View a transactions details</td>
        <td>employee</td>
        <td>Person must be admin or given access to transaction's TF by admin</td>
      </tr>
      <tr>
        <td>Create a new transaction (without expense form)</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Modify a transaction's details</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Delete a transaction</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>View a TF statement</td>
        <td>employee</td>
        <td>Person must be admin or given access to transaction's TF by admin</td>
      </tr>
      <tr>
        <td>Upload a wages data file</td>
        <td>admin</td>
        <td></td>
      </tr>
      <tr>
        <td>Send one-off emails to users</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>View person details</td>
        <td></td>
        <td>Must have manage permission or be the user's own details</td>
      </tr>
      <tr>
        <td>Create new person</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>Modify person</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>Delete person</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>View person list</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>View person's task graph for a project</td>
        <td></td>
        <td>manage permission or given "view task allocation" permission on the project by user with manage permission</td>
      </tr>
      <tr>
        <td>View project list</td>
        <td></td>
        <td>Assigned to all shown projects by user with manage permission</td>
      </tr>
      <tr>
        <td>View project's details</td>
        <td></td>
        <td>Assigned to the project by user with manage permission</td>
      </tr>
      <tr>
        <td>Modify project's details</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>Create new project</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>Delete project</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>Assign people to project</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>Create a task</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>View a tasks details</td>
        <td>tasks</td>
        <td>Assigned to the project by user with manage permission</td>
      </tr>
      <tr>
        <td>Modify a task</td>
        <td>tasks</td>
        <td>Assigned to the project by user with manage permission</td>
      </tr>
      <tr>
        <td>Delete a task</td>
        <td>manage</td>
        <td></td>
      </tr>
      <tr>
        <td>View a project's task graph</td>
        <td></td>
        <td>Assigned to the project by user with manage permission</td>
      </tr>
      <tr>
        <td>View a person's task summary</td>
        <td></td>
        <td>All users can view their own task summary.  Users with manage permission can view anybody's task summary.</td>
      </tr>
      <tr>
        <td>Enter timesheet details</td>
        <td>employee</td>
        <td>Assigned to the project by user with manage permission</td>
      </tr>
      <tr>
        <td>View existing timesheet details</td>
        <td>employee</td>
        <td>All users can view their own timesheet details.  Users with manage permission can view anybody's timesheet details.</td>
      </tr>
    </table><br>
    <i>Table 2 - Security restrictions on application functions</i><br>
</ul>


<h2>Security Implementation</h2>
<h3>Authenticating users and enforcing permissions - PHPLib</h3>
<p>Sessioning, user authentication and permission management is handled using the PHPLib library .  PHPLib uses a session identifier consisting of 32 hexadecimal digits to distinguish between users of the system.  Account usernames and passwords and session information including authentication status is stored in a MySQL database.  Each request must call a function at the start of the request processing to read session information from the database and check that the user is authenticated (page_open()).  Each request must call a function at the end of processing the request to write session information to the database (page_close()).  While processing a request the $auth object provides information about the current user and the $perm object is used to query or check a users' permissions.  See http://phplib.netuse.de for more information on PHPLib.</p>

<h3>Project and TF Access Control</h3>
<p>Project and TF access control is based on information stored in the applications database in the projectPerson and tfPerson tables respectively.  Records in these tables contain a person identifier and a project identifier or TF identifier.  The existance of a record indicates access is permitted to the corresponding project or TF subject to permission requirements defined by table 2.  Additional fields in the projectPerson table are used to give different types of access to the project (some of these fields are not implemented yet)</p>
<p>The tf and project classes each provide the methods have_perm and check_perm to interface with these database tables.  The have_perm methods will return true if the user has permission whereas the check_perm method will abort the script if the user does not have permission.</p>

<h3>Vulnerable PHP And Library Functions</h3>
<p>A number of PHP functions have been identified as potential security weaknesses if they are incorrectly used.  These functions and a description of their usage in Alloc are listed below:</p>
<table border="1">
  <tr>
    <td colspan="2">File reading functions vulnerable to permitting arbitrary file access:</td>
  </tr>
  <tr>
    <td>fopen</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>readfile</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>file</td>
    <td>Only used to read upload wages and invoice files after authentication, admin permission checking and checking supplied file name is an uploaded file</td>
  </tr>
  <tr>
    <td colspan="2">Command execution functions vulnerable to arbitrary command execution weaknesses:</td>
  </tr>
  <tr>
    <td>exec</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>passthru</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>system</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>popen</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>`` (backticks)</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td colspan="2">PHP code execution functions vulnerable to arbitrary code execution weaknesses:</td>
  </tr>
  <tr>
    <td>include</td>
    <td>All variables used with the include function are initialised in PHP code to prevent these from being set arbitrarily by the user</td>
  </tr>
  <tr>
    <td>require</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>eval</td>
    <td>Only used to evaluate template files written by the developers</td>
  </tr>
  <tr>
    <td>preg_replace when used with the /e modifier for executing PHP code</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td colspan="2">Query execution functions vulnerable to arbitrary query execution weaknesses:</td>
  </tr>
  <tr>
    <td>db_alloc::query</td>
    <td>All user input used in queries as strings is escaped using PHP's addslashes function.  The sprintf function with the %d or %f formatter is used wherever user input is used in queries as numbers.</td>
  </tr>
</table>
</body>
</html>
